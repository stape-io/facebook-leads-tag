___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook Leads Tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Stape",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "This tag implements integrations with Meta\u0027s Conversions API for Conversion Leads optimization",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "API Access Token",
    "simpleValueType": true,
    "help": "Set to your Facebook API Access Token. See \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/server-side-api/get-started#access-token\" target\u003d\"_blank\"\u003ehere\u003c/a\u003e for more information.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Facebook Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Set to a valid Facebook Pixel ID."
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event Name",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The event_name parameter should indicate a lead moving through the sales funnel in your CRM"
  },
  {
    "type": "TEXT",
    "name": "leadId",
    "displayName": "Lead ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The 15 or 16 digit leadgen_id from your downloaded leads."
  },
  {
    "type": "TEXT",
    "name": "leadEventSource",
    "displayName": "Lead Event Source",
    "simpleValueType": true,
    "help": "The name of the CRM where the events are coming from.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "eventTime",
    "displayName": "Event Time (Optional)",
    "simpleValueType": true,
    "help": "A Unix timestamp in seconds indicates when your CRM updates the lead stage update event.\u003cbr /\u003e\nDefault: Current time."
  },
  {
    "type": "TEXT",
    "name": "testId",
    "displayName": "Test ID",
    "simpleValueType": true,
    "help": "Provide a Test ID if you want to test server-side events in the Test Events feature of Events Manager.",
    "valueHint": "TEST123"
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');
const Math = require('Math');
const sendHttpRequest = require('sendHttpRequest');
const getTimestampMillis = require('getTimestampMillis');
const getContainerVersion = require('getContainerVersion');
const logToConsole = require('logToConsole');
const getRequestHeader = require('getRequestHeader');

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = isLoggingEnabled ? getRequestHeader('trace-id') : undefined;

const apiVersion = '18.0';
const postUrl =
  'https://graph.facebook.com/v' +
  apiVersion +
  '/' +
  enc(data.pixelId) +
  '/events?access_token=' +
  enc(data.accessToken);

const mappedEventData = getMappedEventData();
const postBody = {
  data: [mappedEventData]
};

if (data.testId) postBody.test_event_code = data.testId;

if (isLoggingEnabled) {
  logToConsole(
    JSON.stringify({
      Name: 'Facebook',
      Type: 'Request',
      TraceId: traceId,
      EventName: mappedEventData.event_name,
      RequestMethod: 'POST',
      RequestUrl: postUrl,
      RequestBody: postBody
    })
  );
}

sendHttpRequest(
  postUrl,
  (statusCode, headers, body) => {
    if (isLoggingEnabled) {
      logToConsole(
        JSON.stringify({
          Name: 'Facebook',
          Type: 'Response',
          TraceId: traceId,
          EventName: mappedEventData.event_name,
          ResponseStatusCode: statusCode,
          ResponseHeaders: headers,
          ResponseBody: body
        })
      );
    }
    if (statusCode >= 200 && statusCode < 300) {
      data.gtmOnSuccess();
    } else {
      data.gtmOnFailure();
    }
  },
  { headers: { 'content-type': 'application/json' }, method: 'POST' },
  JSON.stringify(postBody)
);

function getMappedEventData() {
  return {
    event_name: data.eventName,
    action_source: 'system_generated',
    event_time: data.eventTime || Math.round(getTimestampMillis() / 1000),
    custom_data: {
      lead_event_source: data.leadEventSource,
      event_source: 'crm'
    },
    user_data: {
      lead_id: data.leadId
    }
  };
}

function enc(data) {
  data = data || '';
  return encodeUriComponent(data);
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://graph.facebook.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 02/04/2024, 19:41:46
